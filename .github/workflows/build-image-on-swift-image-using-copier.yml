name: build image on swift image using copier

on:
  workflow_call:
    inputs:
      latest:
        type: string
      push:
        required: true
        type: string
      repositories:
        required: true
        type: string
      swift_version:
        required: true
        type: string
      swift_version_aliases:
        type: string
      swiftlint_revision:
        required: true
        type: string

permissions:
  contents: read
  packages: write

jobs:
  build_tags:
    name: build tags for swift-${{ inputs.swift_version }}
    runs-on: ubuntu-latest
    outputs:
      tags: ${{ steps.tags.outputs.tags }}
    steps:
    - name: Harden the runner (Audit all outbound calls)
      uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
      with:
        egress-policy: audit

    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

    - id: latest_tags
      uses: ./.github/actions/tags_for_latest
      with:
        repositories: ${{ inputs.repositories }}
        swift_version: ${{ toJSON(inputs.swift_version) }}
        swift_version_aliases: ${{ inputs.swift_version_aliases }}
        swiftlint_revision: ${{ toJSON(inputs.swiftlint_revision) }}

    - id: older_tags
      uses: ./.github/actions/tags_for_older
      with:
        repositories: ${{ inputs.repositories }}
        swift_version: ${{ toJSON(inputs.swift_version) }}
        swift_version_aliases: ${{ inputs.swift_version_aliases }}
        swiftlint_revision: ${{ toJSON(inputs.swiftlint_revision) }}

    - id: tags
      run: echo "tags=${{ inputs.latest && steps.latest_tags.outputs.tags || steps.older_tags.outputs.tags }}" >> "$GITHUB_OUTPUT"

  build_image_on_swift_image_using_copier:
    name: Build image on swift-${{ inputs.swift_version }}
    needs: build_tags
    uses: ./.github/workflows/build-image-using-copier.yml
    with:
      image_name: swift-${{ inputs.swift_version }}
      build-args: |
          RUNTIME_IMAGE=swift:${{ inputs.swift_version }}-jammy
      tags: ${{ needs.build_tags.outputs.tags }}
      push: ${{ inputs.push }}
    secrets: inherit
